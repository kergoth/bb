#! /bin/bash

set -e

function is_my_auto() {
    grep -q 'Generated by bb-lockdown' conf/auto.conf
}

if [ $1 = "--reset" ]; then
    echo Removing auto.conf and lockdown-sigs.inc...
    if is_my_auto; then
        rm -f conf/auto.conf
    else
        echo "auto.conf wasn't genearted by bb-lockdown, not removing"
    fi
    rm -f conf/lockdown-sigs.inc
    exit 0
fi

if [ $# -lt 2 ] ; then
    echo "$ bb lockdown EXCLUDE TARGET [ TARGET ... ]"
    exit 1
fi

if [ -e conf/auto.conf ] && ! is_my_auto; then
    echo "Error: auto.conf wasn't genearted by bb-lockdown, not replacing"
    exit 1
fi

# TODO support more than one exclusion
EXCLUDE="$1"
shift
TARGETS="$@"

bitbake $TARGETS -S none
sed -E -e "/^ +$EXCLUDE:/d" <locked-sigs.inc >conf/lockdown-sigs.inc

# TODO somehow emit a note that we're running in lockdown in the build
cat <<EOF >conf/auto.conf
# Generated by bb-lockdown
require conf/lockdown-sigs.inc
SIGGEN_LOCKEDSIGS_TASKSIG_CHECK = ""
EOF
